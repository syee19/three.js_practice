<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Three.js Snowball</title>
    <meta charset="utf-8" />
    <style>
      body {
        margin: 0;
      }
      #info {
        color: aliceblue;
        z-index: 1;
      }
      ul {
        list-style: none;
        margin-top: 0px;
      }
      .btn {
        margin: 20px;
        position: relative;
        border: none;
        display: inline-block;
        padding: 12px 18px;
        border-radius: 15px;
        text-decoration: none;
        font-weight: 600;
        transition: 0.25s;

        background-color: #5b8d80;
        color: aliceblue;
      }
      .container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgb(27, 27, 27);
      }
      #c {
        margin: auto;
        width: 80vw;
        height: auto;
      }
      @media (min-width: 752px) {
        #c {
          margin: auto;
          width: 600px;
          height: 600px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <canvas id="c"></canvas>
      <div id="info">
        <a id="start_demo" class="btn" href="#" role="button">Start demo</a>
        <ul>
          <li>
            X-axis (&beta;): <span id="Orientation_b">0.0</span
            ><span>&deg;</span>
          </li>
          <li>
            Y-axis (&gamma;): <span id="Orientation_g">0.0</span
            ><span>&deg;</span>
          </li>
          <li>
            Z-axis (&alpha;): <span id="Orientation_a">0.0</span
            ><span>&deg;</span>
          </li>
        </ul>
      </div>
    </div>
    <!--

    <script type="importmap">
      {
        "imports": {
          "three": "https://threejs.org/build/three.module.js"
        }
      }
    </script>

    -->
    <script type="module">
      import * as THREE from "https://threejsfundamentals.org/threejs/resources/threejs/r125/build/three.module.js";

      function main() {
        const canvas = document.querySelector("#c");
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

        const fov = 75;
        const aspect = 1; // the canvas default
        const near = 0.1;
        const far = 10;
        const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
        camera.position.z = 4.5;

        const scene = new THREE.Scene();

        const geometry = new THREE.SphereGeometry(2.5, 32, 16);
        const material = new THREE.MeshBasicMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.1,
        });
        const snowBall = new THREE.Mesh(geometry, material);
        scene.add(snowBall);

        //* mesh 생성 함수
        function addShape(x, y, z) {
          //star shape (*)
          const shape = new THREE.Shape()
            .moveTo(3, 5)
            .lineTo(3, 21)
            .lineTo(-3, 21)
            .lineTo(-3, 5)
            .lineTo(-17, 13)
            .lineTo(-20, 8)
            .lineTo(-6, 0)
            .lineTo(-20, -8)
            .lineTo(-17, -13)
            .lineTo(-3, -5)
            .lineTo(-3, -21)
            .lineTo(3, -21)
            .lineTo(3, -5)
            .lineTo(17, -13)
            .lineTo(20, -8)
            .lineTo(6, 0)
            .lineTo(20, 8)
            .lineTo(17, 13)
            .lineTo(3, 5); // close path

          //scale 조정
          var s = 0.005;
          let geometry = new THREE.ShapeGeometry(shape);

          let mesh = new THREE.Mesh(
            geometry,
            new THREE.MeshBasicMaterial({
              color: 0x5b8d80,
              side: THREE.DoubleSide,
            })
          );
          mesh.position.set(x, y, z);
          mesh.scale.set(s, s, s);
          scene.add(mesh);
          return mesh;
        }

        //원점 주변에 일정 간격으로 랜덤하게 * mesh 생성
        var arr = [];
        var velo = [];
        var len = 10;
        const n = 40;
        const seta = (Math.PI * 2) / n;
        var shx, shy, shz;
        for (var i = 0; i < n; i++) {
          len = Math.random() * 0.4 + 0.6;
          shx = len * Math.sin(i * seta);
          shy = len * Math.cos(i * seta);
          shz = Math.sqrt(1 - shx * shx - shy * shy);
          len = Math.random() * 2.3;
          arr.push(addShape(len * shx, len * shy, len * shz));
          //arr.push(addShape(0, 0, 0));
          velo.push(0.005 + Math.random() / 100);
        }

        function resizeRendererToDisplaySize(renderer) {
          const canvas = renderer.domElement;
          const width = canvas.clientWidth;
          const height = canvas.clientWidth;
          const needResize = canvas.width !== width || canvas.height !== height;
          if (needResize) {
            renderer.setSize(width, height, false);
          }
          return needResize;
        }

        // render 혹은 animate loop를 불러 렌더링하기
        function render(time) {
          time *= 0.001;
          if (resizeRendererToDisplaySize(renderer)) {
            camera.updateProjectionMatrix();
          }
          //* 애니메이션
          for (var i = 0; i < arr.length; i++) {
            //if (arr[i].position.y <= -2.5) arr[i].position.y = 2.5;

            arr[i].position.y -= velo[i];
            if (getDistance(arr[i]) >= 2.3) {
              arr[i].position.y *= -1;
            }
            arr[i].lookAt(camera.position);
          }

          renderer.render(scene, camera);
          requestAnimationFrame(render);
        }

        requestAnimationFrame(render);
      }

      main();

      function getDistance(point) {
        var x2 = point.position.x * point.position.x;
        var y2 = point.position.y * point.position.y;
        var z2 = point.position.z * point.position.z;
        //dist = Math.cqrt(x2 + y2 + z2);
        var dist = Math.sqrt(x2 + y2 + z2);
        return dist;
      }

      //Orientation
      function handleOrientation(event) {
        updateFieldIfNotNull("Orientation_a", event.alpha);
        updateFieldIfNotNull("Orientation_b", event.beta);
        updateFieldIfNotNull("Orientation_g", event.gamma);
      }

      function handleMotion(event) {
        updateFieldIfNotNull(
          "Accelerometer_gx",
          event.accelerationIncludingGravity.x
        );
        updateFieldIfNotNull(
          "Accelerometer_gy",
          event.accelerationIncludingGravity.y
        );
        updateFieldIfNotNull(
          "Accelerometer_gz",
          event.accelerationIncludingGravity.z
        );
      }

      function updateFieldIfNotNull(fieldName, value, precision = 1) {
        if (value != null)
          document.getElementById(fieldName).innerHTML =
            value.toFixed(precision);
      }
      let is_running = false;

      let demo_button = document.getElementById("start_demo");
      demo_button.onclick = function (e) {
        e.preventDefault();
        // Request permission for iOS 13+ devices
        if (typeof DeviceMotionEvent.requestPermission === "function") {
          DeviceMotionEvent.requestPermission()
            .then((state) => {
              if (state === "granted") {
                window.alert("granted!");
              } else {
                window.alert("denied!");
              }
            })
            .catch(console.error);
        } else {
          // Handle regular non iOS 13+ devices.
        }

        if (is_running) {
          window.removeEventListener("devicemotion", handleMotion);
          window.removeEventListener("deviceorientation", handleOrientation);
          demo_button.innerHTML = "Start demo";
          is_running = false;
        } else {
          window.addEventListener("devicemotion", handleMotion);
          window.addEventListener("deviceorientation", handleOrientation);
          document.getElementById("start_demo").innerHTML = "Stop demo";
          is_running = true;
        }
      };
    </script>
  </body>
</html>
<!--


  <script>
    // Three.js - Responsive in Paragraph
    // from https://threejs.org/manual/examples/responsive-paragraph.html//Orientation
    function handleOrientation(event) {
      updateFieldIfNotNull("Orientation_a", event.alpha);
      updateFieldIfNotNull("Orientation_b", event.beta);
      updateFieldIfNotNull("Orientation_g", event.gamma);
    }

    function handleMotion(event) {
      updateFieldIfNotNull(
        "Accelerometer_gx",
        event.accelerationIncludingGravity.x
      );
      updateFieldIfNotNull(
        "Accelerometer_gy",
        event.accelerationIncludingGravity.y
      );
      updateFieldIfNotNull(
        "Accelerometer_gz",
        event.accelerationIncludingGravity.z
      );

      updateFieldIfNotNull("Accelerometer_x", event.acceleration.x);
      updateFieldIfNotNull("Accelerometer_y", event.acceleration.y);
      updateFieldIfNotNull("Accelerometer_z", event.acceleration.z);
    }

    function updateFieldIfNotNull(fieldName, value, precision = 1) {
      if (value != null)
        document.getElementById(fieldName).innerHTML = value.toFixed(precision);
    }

    let is_running = false;
    let demo_button = document.getElementById("start_demo");
    demo_button.onclick = function (e) {
      e.preventDefault();

      // Request permission for iOS 13+ devices
      if (
        DeviceMotionEvent &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        DeviceMotionEvent.requestPermission();
      }

      if (is_running) {
        window.removeEventListener("deviceorientation", handleOrientation);
        window.removeEventListener("devicemotion", handleMotion);
        demo_button.innerHTML = "Start demo";
        updateFieldIfNotNull("Orientation_a", 0);
        updateFieldIfNotNull("Orientation_b", 0);
        updateFieldIfNotNull("Orientation_g", 0);
        is_running = false;
      } else {
        window.addEventListener("deviceorientation", handleOrientation);
        window.addEventListener("devicemotion", handleMotion);
        document.getElementById("start_demo").innerHTML = "Stop demo";
        is_running = true;
      }
    };
  </script>

-->
